name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  id-token: write
  packages: write

jobs:
  release-please:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Create Release
        id: release
        uses: googleapis/release-please-action@7987652d64b4581673a76e33ad5e98e3dd56832f # v4.1.3
        with:
          release-type: maven
          package-name: managesievej
          changelog-types: |
            [
              {"type":"feat","section":"Features","hidden":false},
              {"type":"fix","section":"Bug Fixes","hidden":false},
              {"type":"perf","section":"Performance Improvements","hidden":false},
              {"type":"security","section":"Security","hidden":false},
              {"type":"deps","section":"Dependencies","hidden":false},
              {"type":"docs","section":"Documentation","hidden":false},
              {"type":"test","section":"Tests","hidden":false},
              {"type":"refactor","section":"Code Refactoring","hidden":false},
              {"type":"chore","section":"Miscellaneous","hidden":true}
            ]

  build-and-publish:
    name: Build and Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Set up JDK 21
        uses: actions/setup-java@8df1039502a15bceb9433410b1a100fbe190c53b # v4.5.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven settings
        uses: s4u/maven-settings-action@894661b3ddae382f1ae8edbeab60987e08cf0788 # v4.0.0
        with:
          servers: |
            [{
              "id": "github",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.GITHUB_TOKEN }}"
            }]

      - name: Build and package
        run: mvn -B clean package -DskipTests

      - name: Publish to GitHub Packages
        run: mvn -B deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: 'target/*.jar'

      - name: Upload JAR to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for jar in target/*.jar; do
            [ -f "$jar" ] || continue
            filename=$(basename "$jar")
            gh release upload ${{ needs.release-please.outputs.tag_name }} \
              "$jar" \
              --clobber
          done

      - name: Generate checksums
        run: |
          cd target
          for jar in *.jar; do
            [ -f "$jar" ] || continue
            sha256sum "$jar" >> checksums.txt
          done

      - name: Upload checksums to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            target/checksums.txt \
            --clobber

      - name: Update release notes with usage instructions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > usage.md

          ## Installation

          ### Maven

          Add this to your `pom.xml`:

          ```xml
          <dependency>
              <groupId>com.fluffypeople</groupId>
              <artifactId>managesievej</artifactId>
              <version>${{ needs.release-please.outputs.version }}</version>
          </dependency>

          <repositories>
              <repository>
                  <id>github</id>
                  <url>https://maven.pkg.github.com/lenucksi/ManageSieveJ</url>
              </repository>
          </repositories>
          ```

          You'll also need to configure authentication in your `~/.m2/settings.xml`:

          ```xml
          <servers>
              <server>
                  <id>github</id>
                  <username>YOUR_GITHUB_USERNAME</username>
                  <password>YOUR_GITHUB_TOKEN</password>
              </server>
          </servers>
          ```

          ### Gradle

          Add this to your `build.gradle`:

          ```gradle
          repositories {
              maven {
                  url = uri("https://maven.pkg.github.com/lenucksi/ManageSieveJ")
                  credentials {
                      username = project.findProperty("gpr.user") ?: System.getenv("USERNAME")
                      password = project.findProperty("gpr.token") ?: System.getenv("TOKEN")
                  }
              }
          }

          dependencies {
              implementation 'com.fluffypeople:managesievej:${{ needs.release-please.outputs.version }}'
          }
          ```

          ## Verification

          Verify the checksums:

          ```bash
          sha256sum -c checksums.txt
          ```

          Verify SLSA provenance:

          ```bash
          gh attestation verify managesievej-${{ needs.release-please.outputs.version }}.jar \
            --owner lenucksi
          ```
          EOF

          gh release edit ${{ needs.release-please.outputs.tag_name }} \
            --notes-file <(cat <(gh release view ${{ needs.release-please.outputs.tag_name }} --json body -q .body) usage.md)
