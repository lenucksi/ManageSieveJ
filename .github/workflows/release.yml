name: Release

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  attestations: write
  packages: write

jobs:
  release-please:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Create Release
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        with:
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

  build-and-publish:
    name: Build and Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven settings
        uses: s4u/maven-settings-action@894661b3ddae382f1ae8edbeab60987e08cf0788 # v4.0.0
        with:
          servers: |
            [{
              "id": "github",
              "username": "${{ github.actor }}",
              "password": "${{ secrets.GITHUB_TOKEN }}"
            }]

      - name: Build and package
        run: mvn -B clean package -DskipTests

      - name: Publish to GitHub Packages
        run: mvn -B deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: 'target/*.jar'

      - name: Upload JAR to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for jar in target/*.jar; do
            [ -f "$jar" ] || continue
            filename=$(basename "$jar")
            gh release upload ${{ needs.release-please.outputs.tag_name }} \
              "$jar" \
              --clobber
          done

      - name: Generate checksums
        run: |
          cd target
          for jar in *.jar; do
            [ -f "$jar" ] || continue
            sha256sum "$jar" >> checksums.txt
          done

      - name: Upload checksums to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            target/checksums.txt \
            --clobber

      - name: Update release notes with usage instructions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat << 'EOF' > usage.md

          ## Installation

          ### Option 1: JitPack (Recommended - No Authentication Required)

          Add this to your `pom.xml`:

          ```xml
          <repositories>
              <repository>
                  <id>jitpack.io</id>
                  <url>https://jitpack.io</url>
              </repository>
          </repositories>

          <dependencies>
              <dependency>
                  <groupId>com.github.lenucksi</groupId>
                  <artifactId>ManageSieveJ</artifactId>
                  <version>${{ needs.release-please.outputs.tag_name }}</version>
              </dependency>
          </dependencies>
          ```

          **No authentication required!** JitPack builds from GitHub releases automatically.

          ### Option 2: GitHub Packages (Requires Authentication)

          Add this to your `pom.xml`:

          ```xml
          <dependency>
              <groupId>com.fluffypeople</groupId>
              <artifactId>managesievej</artifactId>
              <version>${{ needs.release-please.outputs.version }}</version>
          </dependency>

          <repositories>
              <repository>
                  <id>github</id>
                  <url>https://maven.pkg.github.com/lenucksi/ManageSieveJ</url>
              </repository>
          </repositories>
          ```

          You'll also need to configure authentication in your `~/.m2/settings.xml`:

          ```xml
          <servers>
              <server>
                  <id>github</id>
                  <username>YOUR_GITHUB_USERNAME</username>
                  <password>YOUR_GITHUB_TOKEN</password>
              </server>
          </servers>
          ```

          ### Gradle

          Add this to your `build.gradle`:

          ```gradle
          repositories {
              maven {
                  url = uri("https://maven.pkg.github.com/lenucksi/ManageSieveJ")
                  credentials {
                      username = project.findProperty("gpr.user") ?: System.getenv("USERNAME")
                      password = project.findProperty("gpr.token") ?: System.getenv("TOKEN")
                  }
              }
          }

          dependencies {
              implementation 'com.fluffypeople:managesievej:${{ needs.release-please.outputs.version }}'
          }
          ```

          ## Verification

          Verify the checksums:

          ```bash
          sha256sum -c checksums.txt
          ```

          Verify SLSA provenance:

          ```bash
          gh attestation verify managesievej-${{ needs.release-please.outputs.version }}.jar \
            --owner lenucksi
          ```
          EOF

          gh release edit ${{ needs.release-please.outputs.tag_name }} \
            --notes-file <(cat <(gh release view ${{ needs.release-please.outputs.tag_name }} --json body -q .body) usage.md)

      - name: Trigger JitPack build
        run: |
          echo "Triggering JitPack build for release ${{ needs.release-please.outputs.tag_name }}..."
          # Trigger build by requesting the artifact (30 second timeout to avoid waiting for full build)
          curl -s -m 30 "https://jitpack.io/com/github/lenucksi/ManageSieveJ/${{ needs.release-please.outputs.tag_name }}/build.log" || true
          echo "JitPack build triggered. Check status at: https://jitpack.io/com/github/lenucksi/ManageSieveJ/${{ needs.release-please.outputs.tag_name }}"
